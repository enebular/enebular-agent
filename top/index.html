<div id="loading">Loading...</div>
<div id="install-message"></div>
<div id="wrapper">
	<div class="item">
		<span>userId</span>:
		<input id="userId" class="form-item" type="text"></input>
		<button id="sendBtn">送信</button>
	</div>
	<div class="item">
		<span>agentId</span>:<input id="agentId" class="form-item" readonly="readonly">
	</div>
</div>
<div id="message" class="error"></div>
<style>
	.hidden {
		display: none;
	}
	.item {
		padding: 10px;
	}
	.item button{
		font-size: 18px;
	}
	.form-item {
		font-size: 18px;
		width: 380px;
	}
	.error {
		color: #f00;
	}
</style>
<script>
window.addEventListener('load', function() {
	var wrapper = document.getElementById('wrapper');
	request('GET', '/sys/user_id', {}, function(err, data) {
		loaded();
		if(err) {
			error(err);
			return;
		}
		if(!data.user_id) {
			not_installed_view();
		}else{
			installed_view();
		}
	});
});

function loaded() {
	var wrapper = document.getElementById('wrapper');
	var loading = document.getElementById('loading');
	wrapper.className = '';
	loading.className = 'hidden';
}
function error(text) {
	var message = document.getElementById('message');
	message.textContent = text;
	console.error(text);
}

function not_installed_view() {
	var sendBtn = document.getElementById('sendBtn');
	var userId = document.getElementById('userId');
	sendBtn.addEventListener('click', function(e) {
		var user_id = userId.value;
		request('POST', '/sys/user_id', {user_id : user_id}, function() {
			showAgentId(user_id);
		});
	});
}

function installed_view() {
	var install_message = document.getElementById('install-message');
	install_message.textContent = "インストール済みです。";
	var sendBtn = document.getElementById('sendBtn');
	var userId = document.getElementById('userId');
	sendBtn.addEventListener('click', function(e) {
		var user_id = userId.value;
		showAgentId(user_id);
	});

}

function showAgentId(user_id) {
	var agentId = document.getElementById('agentId');
	request('GET', '/sys/agentid', {user_id:user_id}, function(err, data) {
		if(err) {
			error(err);
			return;
		}
		agentId.value = data.agentid;
	});
}

function request(method, path, params, callback) {
	var params_str = querystring(params)
	var url = path;
	if(method == 'GET') {
		url += '?' + params_str;
	}
	var xhr = createCORSRequest(method , url);
	xhr.withCredentials = true;
	xhr.onload = function() {
		var data = JSON.parse(xhr.responseText);
		callback(data.err, data.content);
	}
	xhr.onerror = function() {
		callback(xhr.statusText || 'unknown error');
	}
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send(params_str);
}

function createCORSRequest(method, url) {
    var xhr = new XMLHttpRequest();
    if ("withCredentials" in xhr) {
        xhr.open(method, url, true);
    } else if (typeof XDomainRequest != "undefined") {
        xhr = new XDomainRequest();
        xhr.open(method, url);
    } else {
        xhr = null;
    }
    return xhr;
}

function querystring(params) {
	var str_arr = [];
	for(k in params) {
		str_arr.push(k + '=' + params[k]);
	}
	return str_arr.join('&');
}

</script>